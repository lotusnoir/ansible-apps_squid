---
- name: "Check for squid executable file"
  ansible.builtin.stat:
    path: '/usr/sbin/squid'
  changed_when: false
  register: squid_binary

- name: "Install tasks"
  when: not squid_binary.stat.exists
  block:
    - name: "Install squid package"
      ansible.builtin.package:
        name: "squid"
        state: present
        update_cache: true
      register: __pkg_result
      retries: 12
      delay: 10
      until: __pkg_result is success

    - name: "Creating log directory"
      ansible.builtin.file:
        path: "/var/log/squid/"
        state: directory
        mode: '0755'

    - name: "Create systemd override directory for squid"
      ansible.builtin.file:
        path: /etc/systemd/system/squid.service.d
        state: directory
        owner: root
        group: root
        mode: "0755"

- name: "Set OS-level nofile limits for squid user"
  ansible.builtin.copy:
    dest: /etc/security/limits.d/squid.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      squid soft nofile {{ squid_max_filedescriptors }}
      squid hard nofile {{ squid_max_filedescriptors }}

- name: "Set file descriptor limit for Squid"
  ansible.builtin.copy:
    dest: /etc/systemd/system/squid.service.d/override.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      [Service]
      LimitNOFILE={{ squid_max_filedescriptors }}
  notify:
    - "Reload daemon"
    - "Restart squid"

- name: "Configure LDAP secret file"
  ansible.builtin.copy:
    dest: "/etc/squid/ldap.secret"
    content: "{{ squid_auth_param_secret }}"
    owner: proxy
    group: proxy
    mode: '0600'
  when:
    - squid_auth_param_secret is defined and squid_auth_param_secret | length > 0
  notify:
    - "Test squid configuration"
    - "Restart squid"

- name: "Configure squid.conf"
  ansible.builtin.template:
    src: "squid.conf.j2"
    dest: "/etc/squid/squid.conf"
    mode: '0644'
  notify:
    - "Test squid configuration"
    - "Restart squid"

- name: "Start and enable squid"
  ansible.builtin.service:
    name: squid
    state: started
    enabled: true
